# Лабораторная работа №3: Builder

## Описание

В `lab3` реализована система билдеров на тематике управления задачами:

- пользователи (`User`);
- проекты (`Project`);
- задачи (`Task`).

Используются mutable-модели для поэтапной настройки и immutable-модели как итоговые результаты сборки.

## Структура папки

- `main.py` — вся реализация и демонстрация.
- `demo_output.sql` — пример SQL, который генерируется `DatabaseBuilder`.

## Что реализовано в коде

### 1) Модели

- Immutable-модели (`@dataclass(frozen=True)`):
  - `UserImmutable`
  - `ProjectImmutable`
  - `TaskImmutable`
- Mutable-модели для билдера:
  - `UserMutable`
  - `ProjectMutable`
  - `TaskMutable`
- Базовая mutable-модель `BaseMutable` хранит:
  - `temp_id`
  - `creation_site` (файл и строка создания объекта).

### 2) Билдеры

- `AbstractBuilder` + 3 реализации:
  - `UserBuilder`
  - `ProjectBuilder`
  - `TaskBuilder`
- Поддерживается fluent-стиль:
  - `UserBuilder().username(...).email(...)`
  - `TaskBuilder().title(...).project(...).assignee(...).completed(...)`
- У билдера есть доступ к mutable-модели (`builder.model`), а на `build(...)` создаётся immutable-объект.

### 3) Валидация

- Валидация в сеттерах mutable-моделей (например, пустое имя/некорректный email).
- `collect_validation()` в каждой модели.
- Агрегация всех ошибок (а не только первой) в `DatabaseBuilder.persist(...)`.
- Ошибки содержат место создания объекта (`creation_site`), например `main.py:45`.

### 4) Дополнительные техники из задания

- Делегат конфигурации:
  - `delegate_configure(obj, configurator)`.
- Scope-подход для применения общей настройки к группе объектов:
  - `ScopeConfigurator`.
- Выход как "база данных":
  - `DatabaseBuilder` создаёт SQL INSERT-скрипт в файл.
  - Связи в SQL идут по ID (owner_id, project_id, assignee_id), а не по прямым ссылкам.
- Отдельный immutable-only билдер:
  - `TaskImmutableBuilder` (функциональный/цепочный стиль, каждый шаг возвращает новую immutable-конфигурацию).

## Соответствие заданию

### Основные пункты

- Группа взаимосвязанных классов на своей тематике: выполнено.
- Билдеры для группы классов с настройкой полей и сборкой immutable: выполнено.
- Валидация в процессе создания: выполнено.
- Использование в `main()`: выполнено.

### Дополнительные пункты (реализованные)

- Fluent builder + delegate configurator + scope: выполнено.
- Улучшенная валидация с указанием места создания + вывод всех ошибок: выполнено.
- Выход в виде SQL/базы данных через отдельный билдер: выполнено.
- Абстрактный билдер и несколько реализаций: выполнено.
- Пример билдера только для immutable-модели: выполнено.

### Что пока не сделано

- Unit tests / snapshot tests.
- Полное разделение всех runtime-моделей только через ID (mutable-объекты внутри сборки всё ещё хранят прямые ссылки).

## Как запускать

### Требования

- Python 3.10+.

### Команда запуска

Из корня проекта:

```powershell
python lab3/main.py
```

Или из папки `lab3`:

```powershell
python main.py
```

### Что выводится

Скрипт демонстрирует:

1. one-step создание immutable-объекта;
2. поэтапную сборку mutable-моделей через билдеры;
3. применение delegate/scope;
4. попытку сохранения с ошибками валидации;
5. успешную генерацию SQL для валидного подмножества;
6. immutable-only builder.

## Важное замечание

В конце `main.py` демо вызывается дважды (и в `if __name__ == "__main__":`, и ещё раз сразу после него), поэтому вывод в консоль дублируется.

